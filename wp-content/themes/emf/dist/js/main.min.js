( function(){

    $( function() {
        'use strict';

        $.each( $('.nice-scroll'), function () {

            new NiceScroll( $(this) );

        } );

        $.each( $('.site'), function () {

            new FullHeightSite( $(this) );

        } );

        $.each( $('.site__content__wrap'), function () {

            new FullHeightSiteInner( $(this) );

        } );

        $.each( $('.site__header'), function () {

            new Menu( $(this) );

        } );

        $.each( $('.menu'), function () {

            new NiceScroll( $(this) );

        } );

        $.each( $('body'), function () {

            new ZoomSite( $(this) );

        } );

        $.each( $( '.gallery' ), function () {
            new Gallery( $(this) );
        } );

        $.each( $( '.site__read-more' ), function () {
            new ReadMore( $(this) );
        } );

        $.each( $( '.accordion' ), function () {
            new Accordion( $(this) );
        } );

        $.each( $( '.awards' ), function () {
            new AwardsGallery( $(this) );
        } );

        $.each( $('.popup-info'), function () {

            new SiteContentPopupNiceScroll( $(this) );

        } );

        $.each( $('.about-portfolio'), function () {

            new AboutPortfolioPopup( $(this) );

        } );


    } );

    var FullHeightSite = function (obj) {

        //private properties
        var _self = this,
            _obj = obj,
            _window = $(window);

        //private methods
        var _getScrollBarWidth = function () {

                var inner = document.createElement('p');
                inner.style.width = "100%";
                inner.style.height = "200px";

                var outer = document.createElement('div');
                outer.style.position = "absolute";
                outer.style.top = "0px";
                outer.style.left = "0px";
                outer.style.visibility = "hidden";
                outer.style.width = "200px";
                outer.style.height = "150px";
                outer.style.overflow = "hidden";
                outer.appendChild (inner);

                document.body.appendChild (outer);
                var w1 = inner.offsetWidth;
                outer.style.overflow = 'scroll';
                var w2 = inner.offsetWidth;
                if (w1 == w2) w2 = outer.clientWidth;

                document.body.removeChild (outer);

                return (w1 - w2);
            },
            _onEvents = function () {

                _window.on( {

                    resize: function () {

                        if( _window.width() >= 1024 - _getScrollBarWidth() ) {

                            _setHeight();

                        }

                    }

                } );

            },
            _init = function () {

                _onEvents();

                if( _window.width() >= 1024 - _getScrollBarWidth() ) {
                    _setHeight();
                }
                _obj[0].obj = _self;

            },
            _setHeight = function () {

                if( _window.height() >= 500 ) {

                    _obj.css( {

                        'min-height': '100%'

                    } );

                } else {

                    _obj.css( {

                        'min-height': '500px'

                    } );

                }

            };

        _init();
    };

    var FullHeightSiteInner = function (obj) {

        //private properties
        var _self = this,
            _obj = obj,
            _window = $(window),
            _title = $('.site__content > .site__title');

        //private methods
        var _getScrollBarWidth = function () {

                var inner = document.createElement('p');
                inner.style.width = "100%";
                inner.style.height = "200px";

                var outer = document.createElement('div');
                outer.style.position = "absolute";
                outer.style.top = "0px";
                outer.style.left = "0px";
                outer.style.visibility = "hidden";
                outer.style.width = "200px";
                outer.style.height = "150px";
                outer.style.overflow = "hidden";
                outer.appendChild (inner);

                document.body.appendChild (outer);
                var w1 = inner.offsetWidth;
                outer.style.overflow = 'scroll';
                var w2 = inner.offsetWidth;
                if (w1 == w2) w2 = outer.clientWidth;

                document.body.removeChild (outer);

                return (w1 - w2);
            },
            _onEvents = function () {

                _window.on( {

                    resize: function () {

                        if( _window.width() >= 1024 - _getScrollBarWidth() ) {

                            _setPosTop();

                        } else {

                            _resetPosTop();

                        }

                    },
                    load: function () {

                        if( _window.width() >= 1024 - _getScrollBarWidth() ) {
                            _setPosTop();
                        }

                    }

                } );

            },
            _init = function () {

                _onEvents();
                _obj[0].obj = _self;

            },
            _setPosTop = function () {

                var bla = _title.offset().top + _title.outerHeight( true );

                _obj.css( {

                    'top': bla

                } );


            },
            _resetPosTop = function () {

                _obj.css( {

                    'top': 'auto'

                } );


            };

        _init();
    };

    var Menu = function (obj) {

        //private properties
        var _self = this,
            _obj = obj,
            _window = $( window),
            _menuBtn = _obj.find('.site__header__btn'),
            _menu = _obj.find('.menu'),
            _html = $('html');

        //private methods
        var _onEvents = function () {

                _window.on( {

                    resize: function () {

                        if( _obj.hasClass( 'opened' ) ) {

                            _obj.removeClass( 'opened' );
                            _html.css( {
                                'overflow-y': 'auto'
                            } );

                        }

                    }

                } );

                _menuBtn.on( {

                    click: function () {

                        if( _obj.hasClass( 'opened' ) ) {

                            _obj.removeClass( 'opened' );
                            _html.css( {
                                'overflow-y': 'auto'
                            } );

                        } else {

                            _obj.addClass( 'opened' );
                            _html.css( {
                                'overflow-y': 'hidden'
                            } );

                        }

                        return false;

                    }

                } );

            },
            _init = function () {

                _onEvents();
                _obj[0].obj = _self;

            };


        _init();
    };

    var NiceScroll = function (obj) {

        //private properties
        var _self = this,
            _obj = obj,
            _window = $( window);

        //private methods
        var _addScroll = function () {

                setTimeout( function() {

                    _obj.niceScroll( {
                        cursorcolor:"#fec303",
                        cursoropacitymin: "1",
                        cursorborderradius: "2px",
                        cursorborder: "none",
                        background: "#3d3e42",
                        cursorwidth: "5px",
                        enablemousewheel: true
                    } );

                }, 10 );

                setTimeout( function() {

                    _obj.getNiceScroll().resize();

                }, 350 );

            },
            _onEvents = function () {

                _window.on( {

                    load: function () {

                        _addScroll();

                    }

                } );

            },
            _init = function () {

                _onEvents();
                _obj[0].obj = _self;

            };


        _init();
    };

    var ZoomSite = function (obj) {

        //private properties
        var _self = this,
            _obj = obj,
            _window = $( window),
            _body = $( 'body' );

        //private methods
        var
            _onEvents = function () {

                _window.on( {

                    resize: function () {

                        _setSize();

                    }

                } );

            },
            _init = function () {

                _onEvents();
                _setSize();
                _obj[0].obj = _self;

            },
            _setSize = function () {

                var newSize;

                if( _window.height() > 500 ) {

                    newSize = ( 100 * ( window.innerHeight / 900 ) ) + 'px';


                } else {

                    newSize = ( 100 * ( 500 / 900 ) ) + 'px';

                }

                _body.css( {
                    'font-size': newSize
                } );

            };


        _init();
    };

    var Gallery = function (obj) {

        //private properties
        var _self = this,
            _obj = obj,
            _galleryTop = obj.find('.gallery__top'),
            _galleryThumbs = obj.find('.gallery__thumbs');

        //private methods
        var _addScroll = function () {

                setTimeout( function() {

                    _obj.niceScroll( {
                        cursorcolor:"#27282d",
                        cursoropacitymin: "1",
                        cursorborderradius: "2px",
                        cursorborder: "none",
                        background: "#3d3e42",
                        cursorwidth: "5px",
                        enablemousewheel: true
                    } );

                }, 10 );

                setTimeout( function() {

                    _obj.getNiceScroll().resize();

                }, 350 );

            },
            _initSwiper = function(){

                var galleryTop = new Swiper( _galleryTop, {
                    nextButton: _galleryThumbs.find( '.swiper-button-next' ),
                    prevButton:  _galleryThumbs.find( '.swiper-button-prev' ),
                    spaceBetween: 10,
                    onSlideChangeStart: function( swiper ){
                        var activeIndex = swiper.activeIndex;
                        $( galleryThumbs.slides ).removeClass( 'is-selected' );
                        $( galleryThumbs.slides ).eq( activeIndex ).addClass( 'is-selected' );
                        galleryThumbs.slideTo( activeIndex, 500, false );
                    }

                });
                var galleryThumbs = new Swiper( _galleryThumbs.find( '.swiper-container' ), {
                    spaceBetween: 37,
                    freeMode: true,
                    centeredSlides: false,
                    slidesPerView: 'auto',
                    touchRatio: 0.2,
                    onClick: function ( swiper ){
                        var clicked = swiper.clickedIndex;
                        swiper.activeIndex = clicked;
                        swiper.updateClasses();
                        $( swiper.slides ).removeClass( 'is-selected' );
                        $( swiper.clickedSlide ).addClass( 'is-selected' );
                        galleryTop.slideTo( clicked, 500, false );

                    },
                    onInit: function (  ){
                        var totalCount = _galleryThumbs.find( '.swiper-slide').length,
                            currentNum;

                        if( totalCount < 10 ) {
                            totalCount = '0' + totalCount;
                        }

                        _galleryThumbs.find( '.gallery__thumbs-total-count' ).text( totalCount );

                        _galleryThumbs.find( '.swiper-slide').each( function() {

                            currentNum = $( this ).index() + 1;

                            if( currentNum < 10 ) {
                                currentNum = '0' + currentNum;
                            } else  if ( currentNum[0] == 0 ) {
                                currentNum = currentNum.slice(1);
                            }

                            $( this ).find( '.gallery__thumbs-current-num' ).text( currentNum );
                        } );


                    }
                });

            },
            _init = function () {
                _obj[0].obj = _self;
                _initSwiper();
            };

        _init();
    };

    var ReadMore = function (obj) {

        //private properties
        var _self = this,
            _obj = obj,
            _window = $( window),
            _body = $( 'body'),
            _items;

        //private methods
        var
            _onEvents = function () {

                _obj.on( {

                    click: function () {

                        _displayItems();

                        return false;

                    }

                } );

            },
            _init = function () {

                _onEvents();
                _disappearItems();
                _obj[0].obj = _self;

            },
            _disappearItems = function () {

                _items = _obj.parent().nextAll();

                _items.css( {
                    display: 'none'
                } );

            },
            _displayItems = function () {

                _items.css( {
                    display: 'block'
                } );

                _obj.css( {
                    display: 'none'
                } );

            };


        _init();
    };

    var Accordion = function (obj) {

        //private properties
        var _self = this,
            _obj = obj,
            _accordionList = _obj.find('>dl'),
            _accordionCaption = _obj.find('>dl>dt'),
            _accordionContent = _obj.find('>dl>dd'),
            _window = $( window),
            _heightList = 0;

        //private methods
        var
            _onEvents = function () {

                _window.on( {
                    load: function() {
                        _heightList = _accordionList.innerHeight();
                    }
                } );

                _accordionCaption.on( {

                    click: function () {

                        var curItem = $(this),
                            nextElem = curItem.next();

                        if( !( curItem.hasClass('active') ) ) {

                            _accordionCaption.removeClass( 'active' );
                            _accordionContent.css( {
                                display: 'none'
                            } );
                            setTimeout( function() {
                                _accordionContent.removeClass( 'visible' );
                            }, 300 );


                            curItem.addClass( 'active' );
                            nextElem.css( {
                                display: 'block'
                            } );
                            setTimeout( function() {
                                nextElem.addClass( 'visible' );
                            }, 300 );

                            _accordionList.css( {
                                'min-height': _heightList + nextElem.innerHeight()
                            } );

                        } else {

                            curItem.removeClass( 'active' );

                            nextElem.css( {
                                display: 'none'
                            } );

                            setTimeout( function() {
                                nextElem.removeClass( 'visible' );
                            }, 300 );

                            _accordionList.css( {
                                'min-height': '1px'
                            } );

                        }

                        return false;

                    }

                } );

            },
            _init = function () {

                _onEvents();
                _disappearItems();
                _obj[0].obj = _self;

            },
            _disappearItems = function () {


            };


        _init();
    };

    var AwardsGallery = function (obj) {

        //private properties
        var _self = this,
            _obj = obj,
            _awardsGallery = _obj.find('.swiper-container');

        //private methods
        var _initSwiper = function(){

                var swiper = new Swiper( _awardsGallery, {
                    pagination: _awardsGallery.find( '.swiper-pagination' ),
                    paginationClickable: true,
                    nextButton: _awardsGallery.find( '.swiper-button-next' ),
                    prevButton: _awardsGallery.find( '.swiper-button-prev' ),
                    //effect: 'fade',
                    spaceBetween: 30
                } );

            },
            _init = function () {
                _obj[0].obj = _self;
                _initSwiper();
            };

        _init();
    };

    var SiteContentPopupNiceScroll = function (obj) {

        //private properties
        var _self = this,
            _obj = obj,
            _window = $( window);

        //private methods
        var _addScroll = function () {

                setTimeout( function() {

                    _obj.niceScroll( {
                        cursorcolor:"#27282d",
                        cursoropacitymin: "1",
                        cursorborderradius: "2px",
                        cursorborder: "none",
                        background: "#3d3e42",
                        cursorwidth: "5px",
                        enablemousewheel: true
                    } );

                }, 10 );

                setTimeout( function() {

                    _obj.getNiceScroll().resize();

                }, 350 );

            },
            _onEvents = function () {

                _window.on( {

                    load: function () {

                        _addScroll();

                    }

                } );

            },
            _init = function () {

                _onEvents();
                _obj[0].obj = _self;

            };

        _init();
    };

    var AboutPortfolioPopup = function (obj) {

        var _obj = obj,
            _popupGallery = $('.gallery-popup'),
            _popupGalleryClose = _popupGallery.find('.gallery-popup__close'),
            _popupGalleryWrap = _popupGallery.find('.gallery-popup__wrap'),
            _popupGalleryLoad = _popupGallery.find('.gallery-popup__preloader'),
            _window = $(window),
            _html = $('html'),
            _currentGalleryImage = _obj.find('.about-portfolio__item'),
            _request = new XMLHttpRequest();


        var _addEvents = function () {

                _currentGalleryImage.on( {
                    'click': function(){
                        var curItem = $( this );

                        _popupGallery.css( {
                            display: 'block'
                        } );

                        if( _window.width() < 1024 ) {

                            _html.css( {
                                'overflow-y': 'hidden'
                            } );

                        }

                        _requestContent( curItem );

                    }
                } );

                _popupGalleryClose.on( {
                    click: function() {

                        _closePopup();

                        return false;

                    }
                } );

            },
            _addScroll = function(){

                $(document).find('.gallery-popup__text').niceScroll( {
                    cursorcolor:"#fec303",
                    cursoropacitymin: "1",
                    cursorborderradius: "2px",
                    cursorborder: "none",
                    background: "#3d3e42",
                    cursorwidth: "5px",
                    enablemousewheel: true
                } );

            },
            _closePopup = function() {

                if( _window.width() < 1024 ) {

                    _html.css( {
                        'overflow-y': 'auto'
                    } );

                }

                _popupGallery.css( {
                    display: 'none'
                } );

                _popupGalleryLoad.css( {
                    display: 'block'
                } );

                _popupGalleryWrap.html('');

            },
            _init = function () {
                _addEvents();
            },
            _requestContent = function ( elem ) {

                _request.abort();
                    console.log($("body").data("action"));
                    console.log(elem.attr('data-id'));
                _request = $.ajax( {
                    url: $("body").data("action"),
                    data: {
                        action: "get_gallery",
                        popupId: elem.attr('data-id')
                    },
                    dataType: 'json',
                    type: "get",
                    success: function (m) {

                        _popupGalleryWrap.html(m.html);


                        if( $(m.html).hasClass('gallery') ) {

                            setTimeout(function(){

                                $.each( $( '.gallery' ), function () {

                                    new Gallery( $(this) );

                                } );

                                _addScroll();

                                _popupGalleryLoad.css( {
                                    display: 'none'
                                } );

                            }, 500);

                        }

                    },
                    error: function (XMLHttpRequest) {
                        if ( XMLHttpRequest.statusText != "abort" ) {
                            alert("ERROR!!!");
                        }
                    }
                } );

            };

        _init();
    };

} )();

